<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitHub 无限网盘</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <style>
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #181717; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen w-screen overflow-hidden flex flex-col font-sans">

  <!-- ================= 1. 登录锁 (保护你的网盘界面) ================= -->
  <div id="loginOverlay" class="fixed inset-0 z-[100] bg-slate-100 flex items-center justify-center hidden">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center">
      <div class="mb-6 text-slate-800 flex justify-center"><i class="ph ph-github-logo text-6xl"></i></div>
      <h2 class="text-2xl font-bold mb-2">GitHub 私有网盘</h2>
      <p class="text-gray-400 text-sm mb-6">请输入访问密码</p>
      <input type="password" id="passwordInput" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 mb-4 focus:outline-none focus:border-slate-800 transition" placeholder="Password">
      <button onclick="checkLogin()" class="w-full bg-slate-800 hover:bg-black text-white font-bold py-3 rounded-lg transition shadow-lg">进入网盘</button>
    </div>
  </div>

  <!-- ================= 2. 预览模式 (分享给别人的界面) ================= -->
  <div id="viewerContainer" class="fixed inset-0 z-[50] bg-black hidden flex flex-col">
    <div class="h-14 bg-black/50 backdrop-blur-md flex items-center justify-between px-4 text-white absolute top-0 w-full z-10">
      <div class="flex items-center gap-2 truncate">
        <i class="ph ph-file text-xl"></i>
        <span id="previewFileName" class="font-medium truncate">Filename.ext</span>
      </div>
      <div class="flex gap-2">
        <a id="downloadBtn" href="#" class="p-2 hover:bg-white/20 rounded-full transition" title="下载" download><i class="ph ph-download-simple text-xl"></i></a>
        <button onclick="exitPreview()" class="p-2 hover:bg-white/20 rounded-full transition" title="进入网盘"><i class="ph ph-house text-xl"></i></button>
      </div>
    </div>
    <div id="previewContent" class="flex-1 flex items-center justify-center overflow-auto p-4 pt-16"></div>
  </div>

  <!-- ================= 3. 网盘主界面 (管理界面) ================= -->
  <div id="driveApp" class="flex-1 flex flex-col h-full hidden">
    <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 flex-shrink-0">
      <div class="flex items-center gap-3">
        <div class="bg-slate-800 text-white p-2 rounded-lg"><i class="ph ph-github-logo text-xl"></i></div>
        <h1 class="text-xl font-bold tracking-tight text-slate-800">My Git Drive</h1>
      </div>
      <div class="flex items-center gap-4">
        
        <!-- 上传文件 -->
        <label class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full font-medium transition shadow-md shadow-blue-100 flex items-center gap-2 text-sm">
            <i class="ph ph-file-plus text-lg"></i><span>上传文件</span>
            <input type="file" id="fileUploader" class="hidden" multiple>
        </label>

        <!-- 上传文件夹 (新增支持) -->
        <label class="cursor-pointer bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-full font-medium transition shadow-md shadow-indigo-100 flex items-center gap-2 text-sm">
            <i class="ph ph-folder-plus text-lg"></i><span>上传文件夹</span>
            <input type="file" id="folderUploader" class="hidden" webkitdirectory directory multiple>
        </label>

        <button onclick="createNewFolder()" class="bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 px-3 py-2 rounded-full font-medium transition flex items-center gap-2 text-sm">
            <i class="ph ph-folder-simple-plus text-lg"></i><span>新建文件夹</span>
        </button>
        <div class="w-px h-8 bg-slate-200 mx-2"></div>
        <button onclick="logout()" class="text-slate-400 hover:text-red-500 transition" title="退出"><i class="ph ph-sign-out text-xl"></i></button>
      </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        <aside class="w-64 bg-slate-50 border-r border-slate-200 hidden md:flex flex-col p-4">
            <nav class="space-y-1">
                <button onclick="navigateTo('')" class="w-full flex items-center gap-3 px-4 py-3 bg-slate-200 text-slate-800 rounded-lg font-medium"><i class="ph ph-hard-drives text-lg"></i> 全部文件</button>
            </nav>
            <div class="mt-auto p-4 bg-slate-100 rounded-xl">
                <div class="flex items-center gap-2 text-sm text-slate-500 mb-2"><i class="ph ph-database"></i> 仓库空间</div>
                <div class="text-xs text-slate-400">推荐单个仓库 < 1GB<br>单文件 < 50MB (API限制)</div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-white overflow-hidden relative">
            <div class="h-14 border-b border-slate-100 flex items-center px-6 gap-2 text-sm text-slate-600 flex-shrink-0">
                <button onclick="navigateTo('')" class="hover:text-blue-600 hover:bg-blue-50 px-2 py-1 rounded transition"><i class="ph ph-house"></i> 根目录</button>
                <div id="breadcrumbs" class="flex items-center gap-1"></div>
                <div class="ml-auto flex items-center gap-2">
                    <span id="loadingIndicator" class="hidden flex items-center gap-2 text-blue-500 bg-blue-50 px-3 py-1 rounded-full text-xs"><div class="loader !w-3 !h-3 !border-2"></div> 请求中...</span>
                    <button onclick="refreshDrive()" class="p-2 hover:bg-slate-100 rounded-lg transition" title="刷新"><i class="ph ph-arrows-clockwise text-lg"></i></button>
                </div>
            </div>

            <div id="fileListArea" class="flex-1 overflow-y-auto p-6">
                <div id="emptyState" class="hidden h-full flex flex-col items-center justify-center text-slate-300">
                    <i class="ph ph-folder-open text-6xl mb-4"></i><p>文件夹是空的</p>
                </div>
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 folder-section hidden">Folders</h3>
                <div id="foldersGrid" class="folder-grid mb-8"></div>
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 file-section hidden">Files</h3>
                <div id="filesGrid" class="folder-grid"></div>
            </div>

            <!-- 上传进度悬浮窗 -->
            <div id="uploadProgress" class="absolute bottom-6 right-6 bg-white shadow-2xl border border-slate-100 p-4 rounded-xl w-80 hidden z-20">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-bold text-slate-700">正在上传...</span>
                    <span id="uploadPercent" class="text-xs text-blue-600 font-mono">0%</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-2">
                    <div id="uploadBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div id="uploadDetail" class="text-xs text-slate-400 mt-1 truncate">请勿关闭页面...</div>
            </div>
        </main>
    </div>
  </div>

<script>
    // ================= 配置区 (请修改这里！) =================
    const GITHUB_CONFIG = {
        username: "你的GitHub用户名",     // 例如: "Nolan"
        repo: "my-drive-data",          // 你创建的用于存文件的Public仓库名
        token: "你的ghp_开头的Token",    // Personal Access Token (权限选 repo)
        branch: "main"                  // 分支名
    };
    
    const ADMIN_PASS = 'admin'; // 你的登录密码
    // ======================================================

    let currentPath = ''; 

    // 初始化检查
    const params = new URLSearchParams(window.location.search);
    const shareFile = params.get('f');
    if (shareFile) { showViewer(shareFile); } 
    else { document.getElementById('loginOverlay').classList.remove('hidden'); }

    // 认证与导航
    window.checkLogin = function() {
        if (document.getElementById('passwordInput').value === ADMIN_PASS) {
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('driveApp').classList.remove('hidden');
            refreshDrive();
        } else { alert('密码错误'); }
    };
    window.logout = () => location.reload();
    window.refreshDrive = refreshDrive;
    window.navigateTo = navigateTo;
    window.createNewFolder = createNewFolder;
    window.deleteItem = deleteItem;
    window.openSharePreview = openSharePreview;
    window.copyLink = copyLink;
    window.exitPreview = () => window.location.href = window.location.href.split('?')[0];

    // --- GitHub API 核心 ---
    async function apiCall(endpoint, method = 'GET', body = null) {
        // 防止双斜杠
        const cleanEndpoint = endpoint.startsWith('/') ? endpoint.slice(1) : endpoint;
        const url = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${cleanEndpoint}`;
        const headers = {
            'Authorization': `token ${GITHUB_CONFIG.token}`,
            'Accept': 'application/vnd.github.v3+json'
        };
        const options = { method, headers };
        if (body) options.body = JSON.stringify(body);
        
        const res = await fetch(url, options);
        // GitHub API 删除成功返回 200, 上传成功返回 201
        if (!res.ok && res.status !== 404) {
            const err = await res.json().catch(()=>({}));
            throw new Error(err.message || `GitHub API Error: ${res.status}`);
        }
        return res.status === 404 ? null : await res.json();
    }

    // 刷新列表
    async function refreshDrive() {
        const loading = document.getElementById('loadingIndicator');
        loading.classList.remove('hidden');
        try {
            const data = await apiCall(currentPath);
            renderFileList(Array.isArray(data) ? data : []);
        } catch (error) { console.error(error); alert('加载失败: ' + error.message); }
        loading.classList.add('hidden');
    }

    function renderFileList(items) {
        const foldersGrid = document.getElementById('foldersGrid');
        const filesGrid = document.getElementById('filesGrid');
        foldersGrid.innerHTML = ''; filesGrid.innerHTML = '';

        // 过滤掉 .gitkeep
        const validItems = items.filter(i => i.name !== '.gitkeep');

        if (!validItems.length) {
            document.getElementById('emptyState').classList.remove('hidden');
            document.querySelector('.folder-section').classList.add('hidden');
            document.querySelector('.file-section').classList.add('hidden');
            return;
        }
        document.getElementById('emptyState').classList.add('hidden');

        let hasFolder = false;
        let hasFile = false;

        validItems.forEach(item => {
            const div = document.createElement('div');
            div.className = 'group relative bg-slate-50 border border-slate-200 hover:border-blue-400 hover:shadow-md rounded-xl p-4 flex flex-col items-center justify-center text-center cursor-pointer transition h-40';

            if (item.type === 'dir') {
                hasFolder = true;
                div.innerHTML = `<i class="ph-fill ph-folder text-blue-500 text-5xl mb-3"></i><span class="text-sm font-medium text-slate-700 truncate w-full px-2">${item.name}</span>`;
                div.onclick = () => navigateTo(item.path);
                foldersGrid.appendChild(div);
            } else {
                hasFile = true;
                const ext = item.name.split('.').pop().toUpperCase();
                let iconClass = 'ph-file-text', colorClass = 'text-slate-500';
                if (['JPG','PNG','JPEG','GIF','WEBP'].includes(ext)) { iconClass = 'ph-image'; colorClass = 'text-purple-500'; }
                if (['PDF'].includes(ext)) { iconClass = 'ph-file-pdf'; colorClass = 'text-red-500'; }
                if (['MP4','MOV'].includes(ext)) { iconClass = 'ph-film-strip'; colorClass = 'text-pink-500'; }
                if (['ZIP','RAR'].includes(ext)) { iconClass = 'ph-file-zip'; colorClass = 'text-orange-500'; }

                div.innerHTML = `
                    <i class="ph-fill ${iconClass} ${colorClass} text-5xl mb-3"></i>
                    <span class="text-sm font-medium text-slate-700 truncate w-full px-2">${item.name}</span>
                    <span class="text-xs text-slate-400 mt-1">${formatSize(item.size)}</span>
                    <div class="absolute inset-0 bg-black/5 backdrop-blur-[1px] opacity-0 group-hover:opacity-100 transition rounded-xl flex items-center justify-center gap-2">
                        <button onclick="event.stopPropagation(); openSharePreview('${item.path}')" class="bg-white text-slate-700 p-2 rounded-full shadow hover:text-blue-600 hover:scale-110 transition" title="预览"><i class="ph ph-eye"></i></button>
                        <button onclick="event.stopPropagation(); copyLink('${item.path}')" class="bg-white text-slate-700 p-2 rounded-full shadow hover:text-green-600 hover:scale-110 transition" title="复制链接"><i class="ph ph-link"></i></button>
                        <button onclick="event.stopPropagation(); deleteItem('${item.path}', '${item.sha}')" class="bg-white text-slate-700 p-2 rounded-full shadow hover:text-red-600 hover:scale-110 transition" title="删除"><i class="ph ph-trash"></i></button>
                    </div>`;
                filesGrid.appendChild(div);
            }
        });
        document.querySelector('.folder-section').classList.toggle('hidden', !hasFolder);
        document.querySelector('.file-section').classList.toggle('hidden', !hasFile);
    }

    function navigateTo(path) { currentPath = path; updateBreadcrumbs(); refreshDrive(); }

    function updateBreadcrumbs() {
        const bc = document.getElementById('breadcrumbs');
        bc.innerHTML = '';
        if (!currentPath) return;
        const parts = currentPath.split('/');
        let buildPath = '';
        parts.forEach((part, i) => {
            buildPath += (i === 0 ? '' : '/') + part;
            const span = document.createElement('span');
            span.className = 'flex items-center gap-1 text-slate-400';
            span.innerHTML = `<i class="ph ph-caret-right text-xs"></i> <button onclick="navigateTo('${buildPath}')" class="hover:text-blue-600 hover:underline text-slate-600 font-medium">${part}</button>`;
            bc.appendChild(span);
        });
    }

    async function createNewFolder() {
        const name = prompt("文件夹名称:");
        if (!name) return;
        // GitHub Trick: 创建一个 .gitkeep 文件来占位
        const path = currentPath ? `${currentPath}/${name}/.gitkeep` : `${name}/.gitkeep`;
        try {
            // 上传一个空内容的 base64
            await apiCall(path, 'PUT', {
                message: `Create folder ${name}`,
                content: "", // 空内容 base64
                branch: GITHUB_CONFIG.branch
            });
            refreshDrive();
        } catch(e) { alert("创建失败: " + e.message); }
    }

    async function deleteItem(path, sha) {
        if (!confirm('确定删除?')) return;
        try {
            await apiCall(path, 'DELETE', {
                message: "Delete via Web Drive",
                sha: sha,
                branch: GITHUB_CONFIG.branch
            });
            refreshDrive();
        } catch(e) { alert("删除失败: " + e.message); }
    }

    // --- 上传逻辑 (文件 + 文件夹递归) ---
    document.getElementById('fileUploader').addEventListener('change', (e) => handleUpload(e.target.files));
    document.getElementById('folderUploader').addEventListener('change', (e) => handleUpload(e.target.files, true));

    async function handleUpload(files, isFolder = false) {
        if (!files.length) return;
        document.getElementById('uploadProgress').classList.remove('hidden');
        let completed = 0;
        
        for (let file of files) {
            // 限制大小
            if (file.size > 30 * 1024 * 1024) {
                console.warn(`Skip large file: ${file.name}`);
                continue;
            }

            // 计算路径
            let uploadPath;
            if (isFolder && file.webkitRelativePath) {
                uploadPath = currentPath ? `${currentPath}/${file.webkitRelativePath}` : file.webkitRelativePath;
            } else {
                uploadPath = currentPath ? `${currentPath}/${file.name}` : file.name;
            }

            document.getElementById('uploadDetail').innerText = `正在上传: ${file.name}`;
            
            try {
                const base64Content = await toBase64(file);
                // 检查是否存在 (覆盖需要 SHA)
                const existing = await apiCall(uploadPath).catch(()=>null);
                
                await apiCall(uploadPath, 'PUT', {
                    message: `Upload ${file.name}`,
                    content: base64Content,
                    sha: existing ? existing.sha : undefined,
                    branch: GITHUB_CONFIG.branch
                });
            } catch (error) { console.error(error); }
            
            completed++;
            document.getElementById('uploadBar').style.width = `${Math.round((completed/files.length)*100)}%`;
            document.getElementById('uploadPercent').innerText = `${Math.round((completed/files.length)*100)}%`;
        }
        setTimeout(() => { document.getElementById('uploadProgress').classList.add('hidden'); refreshDrive(); }, 1000);
    }

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
    });

    // --- 预览/分享 (jsDelivr 加速) ---
    function getPublicUrl(path) {
        // 直连 jsDelivr CDN
        return `https://cdn.jsdelivr.net/gh/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}@${GITHUB_CONFIG.branch}/${encodeURI(path)}`;
    }

    function openSharePreview(path) {
        const baseUrl = window.location.href.split('?')[0];
        showViewer(path);
    }

    function copyLink(path) {
        const baseUrl = window.location.href.split('?')[0];
        const shareLink = `${baseUrl}?f=${encodeURIComponent(path)}`;
        navigator.clipboard.writeText(shareLink).then(() => alert("分享链接已复制!"));
    }

    function showViewer(path) {
        const decodedPath = decodeURIComponent(path);
        document.getElementById('loginOverlay').classList.add('hidden');
        document.getElementById('driveApp').classList.add('hidden');
        document.getElementById('viewerContainer').classList.remove('hidden');
        document.getElementById('previewFileName').innerText = decodedPath.split('/').pop();

        const publicUrl = getPublicUrl(decodedPath);
        document.getElementById('downloadBtn').href = publicUrl;

        const contentDiv = document.getElementById('previewContent');
        const ext = decodedPath.split('.').pop().toLowerCase();
        let html = '';
        
        // 增加 loading
        contentDiv.innerHTML = '<div class="loader"></div>';

        const imgExts = ['jpg','jpeg','png','gif','webp','svg'];
        const vidExts = ['mp4','webm','mov'];
        const pdfExts = ['pdf'];

        if (imgExts.includes(ext)) {
            html = `<img src="${publicUrl}" class="max-w-full max-h-full shadow-2xl rounded-lg" />`;
        } else if (vidExts.includes(ext)) {
            html = `<video controls autoplay class="max-w-full max-h-[80vh] shadow-2xl rounded-lg"><source src="${publicUrl}"></video>`;
        } else if (pdfExts.includes(ext)) {
            html = `<iframe src="${publicUrl}" class="w-full h-full bg-white rounded-lg shadow-2xl"></iframe>`;
        } else {
            html = `<div class="text-center text-white"><p class="text-xl mb-6">无法直接预览</p><a href="${publicUrl}" download class="bg-blue-600 text-white px-8 py-3 rounded-full font-bold">下载文件</a></div>`;
        }
        setTimeout(() => { contentDiv.innerHTML = html; }, 500);
    }

    function formatSize(bytes) {
        if (!bytes) return '0 B';
        const k = 1024; const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
</script>
</body>
</html>
